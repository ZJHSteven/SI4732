# 问题诊断和测试指南

## 问题1：FM扫描只到107.9MHz的解决方案

### 已实施的改进：
1. **扩展频段范围**：从88-108MHz扩展到87.5-108.5MHz
2. **降低搜索阈值**：
   - SNR阈值：3dB → 2dB
   - RSSI阈值：20dBµV → 15dBµV  
   - 频偏容忍：±50kHz → ±75kHz
3. **增强扫描算法**：
   - 增加调试信息
   - 添加手动扫描备用方案
   - 改进边界检测

### 测试步骤：
```
1. 重新烧录代码
2. 输入 'seek' 重新搜索
3. 查看详细的搜索过程输出
4. 如果仍有问题，可以手动设置频率：freq 108.0
```

## 问题2：ADF4351无输出信号的诊断

### 原因分析：
在FM搜台模式下，系统使用"FM直通路径"，ADF4351不会被激活。只有在AM分析模式或ADF扫频模式下，ADF4351才会工作。

### 测试步骤：

#### 1. 基本功能测试
```
adftest 100.0    # 测试100MHz输出
adftest 108.0    # 测试108MHz输出  
adftest 95.5     # 测试95.5MHz输出
```

#### 2. 检查硬件连接
```
status           # 查看系统状态
adfon            # 强制启用ADF4351
adfoff           # 禁用ADF4351
```

#### 3. 切换到AM模式测试
```
seek             # 先搜索FM电台
station 1        # 选择第一个电台
am               # 切换到AM分析模式（会激活ADF4351）
```

#### 4. ADF扫频模式测试
```
adf              # 切换到ADF扫频模式
fastscan         # 开始快速扫频
```

### 预期的示波器测量点：

1. **ADF4351输出引脚**：应该看到LO频率信号
   - 对于RF=108MHz：LO = 108MHz - 10.7MHz = 97.3MHz
   - 对于RF=100MHz：LO = 100MHz - 10.7MHz = 89.3MHz

2. **锁定检测引脚(LD)**：锁定时应为高电平

### 可能的问题和解决方案：

#### 如果ADF4351仍无输出：

1. **检查SPI连接**：
   ```
   LE (Latch Enable): GPIO 5
   SCK (Serial Clock): GPIO 18  
   MOSI (Data): GPIO 23
   CE (Chip Enable): GPIO 32
   ```

2. **检查电源**：
   - ADF4351需要3.3V电源
   - 确保电流供应充足

3. **检查参考时钟**：
   - 系统配置为50MHz参考时钟
   - 确保参考时钟信号正常

4. **检查芯片使能**：
   - CE引脚应连接到GPIO 32
   - 确保CE信号正常

### 调试命令总结：

```bash
# 基本诊断
help              # 查看所有命令
status            # 查看系统状态

# FM扫描测试  
fm                # 切换FM模式
seek              # 搜索电台
list              # 显示电台列表

# ADF4351测试
adftest 108.0     # 测试108MHz输出
adfon             # 启用ADF输出
am                # 切换到AM模式（激活ADF）
adf               # 切换到ADF扫频模式

# 路径控制测试
path1             # FM直通路径
path2             # AM降频路径
```

### 成功的输出示例：

```
adftest 108.0
🔧 测试ADF4351输出: 108.00 MHz
📡 设置RF频率: 108.000 MHz  
📡 计算LO频率: 97.300 MHz
✅ ADF4351已锁定 - 应该可以在示波器上看到信号
📊 检查以下频率:
   - LO输出: 97.300 MHz
   - RF目标: 108.000 MHz  
   - 中频差: 10.700 MHz
```

如果看到以上输出但示波器仍无信号，则可能是硬件连接问题。
